Sinatra MVC
===========

Sinatra MVC is a simple attempt to get some kind of MVC structure on top
of Sinatra, without losing much of the original Sinatra _"feeling"_. It
uses Datamapper for it's model layer and custom software for the other
two.

It's recommended to read the [Sinatra README][6] first before continuing
with this document.

A rule of thumb: In command line examples, a `$` prefix means your own
user and a `#` prefix is a root terminal.

System Dependencies
-------------------

Your system needs to have a working Ruby 1.9.2 installation (or later,
but I haven't tested that). You'll also need some kind of database. The
currently supported databases are:

* MySQL
* PostgreSQL
* Sqlite3

Sinatra MVC also has the possibility to use Memcache as a session storage
system. This is the default. It's recommended as well.

The framework has been developed on a Debian Sid platform, and as such
Debian is the preferred platform of choice. If you encounter problems
caused by Debian-specific hacks, please let me know. The interpreter
string has been set to `ruby1.9.1`, but you can easily change that in
`sinatra-mvc.rb` if you wish. Don't worry, that's the only place the 
"weird" interpreter string is used.

Throughout the documentation Debian-specific help will be provided. Other
operating systems might be added later.

Installing
----------

Installing Sinatra MVC is reasonably simple. All you need is Mercurial,
some development headers (distributed by your operating system) and
a terminal.

For Debian users, the following command will suffice (or ask your system
administrator to install the packages for you):

    # apt-get install ruby1.9.1-full libmysqlclient-dev libpq-dev libsqlite3-dev
    # gem1.9.1 install bundler

You'll have to make sure the Ruby gem path is in your terminal's `$PATH`.
For Debian, adding the following line to your `~/.bashrc` will do just
fine. Don't forget to restart your shell to enable this!

    PATH="/var/lib/gems/1.9.1/bin/:$PATH"

First, you'll need to download the source tree. Since this is a
development project, you'll have to use the latest and greatest release
(e.g. the Mercurial tip) for the time being.

    $ hg clone ssh://gescheurd.wasda.nl/~jorrizza/src/sinatra-mvc my_project
    $ cd my_project

Using bundler, we can install all of our gems without getting in the way
of your host Ruby installation. The following command will install the
gems in the `vendor/` directory and add the gem's applications in `bin/`.

    $ bundle install --path vendor --binstubs

To test your local bunch of gems, let's generate an HTML file out of this
documentation.

    $ bin/maruku README.md

This'll generate a nice HTML file for you.

Updating gems is pretty easily done. Now you've got your bundle complete,
you'll just have to run:

    $ bundle update

Joris will update Sinatra MVC every once in a while. To get the latest
updates from his repository, just pull (and merge if needed).

    $ hg pull
    $ hg merge

Running your Application
------------------------

Sinatra is built on top of Rack, so every method that can run Rack will
be able to run your Sinatra MVC application. That even includes things
like [Shotgun][2], [Phusion Passenger][3] and [Heroku][4].

There are basically two ways to run your application. During development,
it's okay to run your application using the built-in thin server. This
will serve all the static files and handle the application calls at the
same time. Just simply run:

    $ ./sinatra-mvc.rb

This will run your application in development mode, allowing you to see
the access log in the terminal and tracebacks when you've made an _oops_.
It also enables nicely formatted error pages, generated by Sinatra.

In production, there are several ways you can use Rack to serve your app.
I suggest using thin, proxied by Nginx for the static files. The
supplied `config.ru` Rackup file will handle things for you. Be sure to
configure your server to run in production mode. This will disable the
helpful error messages and other development coolness.

Static Files
------------

Static files are served from the `public/` directory. If you create a file
at `public/css/site/main.css`, the HTTP request to 
`/public/css/site/main.css` will serve that file. You're completely free
to specify your own directory structure.

Controllers
-----------

Controllers are vastly simplified and are not at all linked to models.
If you want to make it so, you're free to do so. The controller files
reside under `app/`. All of the files are read recursively during
application startup. This means you can apply a sane directory structure
to the app directory to make your controllers easier to understand. Since
only the application's startup time is slightly influenced by the
complexity of the directory structure and the amount of files in them,
you're encouraged to split up your controllers as much as needed.

The code that goes into these files ends up in Sinatra's [application
scope][5]. You can fully use Sinatra's DSL to get things done. To keep
the original Sinatra _vibe_ alive, there's no central routing method.
Instead, you're required to use Sinatra's DSL to specify what happens
after what request.

Let's assume you've got a blog with posts, and you want to edit a certain
post. In this case, you might choose for the following file:
`app/post/modify.rb`.

    get '/post/modify/:id'
      @post = Post.get id
      halt 404 unless @post

      erubis :post_modify
    end

    post '/post/modify/:id'
      @post = Post.get id
      halt 404 unless @post

      fetch 1, @post, '/post/read/' + id, nil

      erubis :post_modify
    end

As you can see, not much has been changed from the original concept.
The post itself is a Datamapper model, and is used a such.

In the post bit of the controller there's an awesome little function call,
allowing you to populate your model with incoming POST data.

Views
-----

Sinatra MVC has all the [view options][1] Sinatra has. Some things differ
though, since this framework supports an URL-directory mapping for views.

Using _erubis_ is recommended, but you might as well use other templating
methods. At the moment the following things are supported (notice the lack
of the nasties _builder_, _haml_ and _sass_):

* erubis
* markdown
* textile
* liquid
* less

Some sidemarks with this selection of templating solutions:

* You can use less, but not as a template call. Sinatra MVC wants to keep
  things speedy, so please use `bin/lessc` to compile your less templates.
* Markdown support in R18n is done using Maruku, but Sinatra (tilt) prefers
  rdiscount. Both are included. One of the future things that will be done
  is removing one of the two. This will have to do for now.

TODO

Models
------

TODO

Internationalisation
--------------------

TODO

Utilities
---------

TODO

[1]: http://rubydoc.info/gems/sinatra/1.1.0/file/README.rdoc#Views___Templates
[2]: http://rtomayko.github.com/shotgun/
[3]: http://www.modrails.com/
[4]: http://heroku.com/
[5]: http://www.rubydoc.info/gems/sinatra/1.1.0/file/README.rdoc#Application_Class_Scope
[6]: http://www.rubydoc.info/gems/sinatra/1.1.0/file/README.rdoc